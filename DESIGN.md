# VoiceDongle (ESP32-S3) — Full Specification

## 1. Purpose
A USB device that:
- captures voice audio (when enabled),
- sends it to a configurable remote speech-to-text (STT) service over the internet,
- types the returned text into the connected host computer as a standard USB HID keyboard,
- supports configuration via a web interface (AP portal and LAN UI),
- provides deterministic physical controls (button holds) for AP mode and factory reset,
- shows recording enable state via red/green LED.

---

## 2. Functional Specifications

### 2.1 USB (Host Interface)
- USB device enumerates as **HID Keyboard**.
- No host drivers required (standard HID).
- Text output is generated by emitting HID key reports.
- Typing is **rate-limited** (configurable) to avoid dropped keystrokes.
- Initial supported keyboard layout: **US** (ASCII subset sufficient for typical dictation).
- Optional behavior: append newline after each finalized transcription.

### 2.2 Recording Enable + LED
- **LED green**: recording enabled.
- **LED red**: recording disabled.
- When recording is disabled:
  - microphone capture is stopped (or discarded immediately),
  - no network STT requests are made,
  - HID typing queue is cleared,
  - no additional processing occurs.

### 2.3 Audio Capture
- Microphone: **I2S MEMS** mic.
- Default format:
  - 16,000 Hz
  - 16-bit PCM
  - mono

### 2.4 Silence Gate + Pre-Roll (Required)
When recording is enabled (LED green), implement a simple gating system:
- Maintain a **pre-roll ring buffer** continuously (while enabled).
- Do **not** send anything to STT while input is “silent”.
- When sound exceeds `start_threshold`:
  - begin a new utterance,
  - prepend `pre_roll_ms` from the ring buffer so speech start is not clipped,
  - append live audio until speech ends.
- Speech end condition:
  - input remains below stop threshold for `silence_hang_ms`, OR
  - utterance reaches `max_utt_ms`.
- After speech end:
  - send utterance audio to STT,
  - type STT text response to host.

Silence gate implementation requirements:
- Frame-based energy measurement (RMS or mean absolute value) on 10–30ms frames.
- Hysteresis supported via `stop_threshold_ratio`.

### 2.5 Networking Modes (STA by Default; AP for Setup/Recovery)

#### Normal Mode (STA)
- Device joins user Wi-Fi network using configured SSID/PSK.
- Device performs STT requests via internet access from STA connection.
- Web UI is available on LAN at `http://<device-ip>/`.
- Optional: mDNS name (e.g., `voicedongle.local`).

#### AP Mode (SoftAP Portal)
- Device starts SoftAP for provisioning/recovery.
- Portal is accessible at `http://192.168.4.1/`.
- SoftAP uses WPA2-PSK (default credentials documented; changeable in settings).

### 2.6 Button Handling (Single Button)
All timings are based on continuous press duration, with debounce and monotonic timing.

- **Short press (< 5s)**: toggle recording enable (red/green).
- **Hold ≥ 5s and < 15s**: enter AP mode (without wiping configuration).
- **Hold ≥ 15s**: factory reset (wipe configuration) and reboot into AP mode.

Rules:
- 15s action overrides 5s action.
- Trigger at most once per press.

### 2.7 Error Handling (Fail Closed)
- If STT request fails, times out, or returns invalid/empty response:
  - **do not type anything**.
- If Wi-Fi STA join fails on boot:
  - fall back to AP mode after timeout.

---

## 3. Boot + Fallback Behavior

### 3.1 Boot Sequence
1. Initialize hardware (button, LED).
2. Load config from NVS.
3. If config missing or invalid → AP mode.
4. Else attempt STA join with timeout (default 30 seconds).
5. If STA join succeeds → normal mode.
6. If STA join fails → AP mode.

### 3.2 AP Mode Exit
- User saves configuration (Wi-Fi + STT) in portal UI.
- User clicks **Apply & Reboot**.
- Device reboots and attempts STA join.

---

## 4. Configuration Specifications

### 4.1 Authentication
- First-time access uses default credentials and requires setting an admin password.
- After admin password is set:
  - default credentials are disabled until factory reset.
- Web UI uses a session cookie with inactivity timeout.

### 4.2 Configurable Settings

**Wi-Fi**
- STA SSID
- STA PSK

**SoftAP**
- AP SSID
- AP PSK

**STT Service**
- Endpoint URL
- Auth:
  - bearer token, OR
  - header key/value
- Optional JSON parameters blob passed through to endpoint (if supported)

**Keyboard**
- layout (initial: `us`)
- key delay (ms)
- append newline (bool)

**Audio Gate**
- sample rate (fixed default; optional config)
- `pre_roll_ms`
- `silence_hang_ms`
- `max_utt_ms`
- `start_threshold`
- `stop_threshold_ratio`

### 4.3 Import/Export
- Export configuration as `config.json`.
- Import `config.json` via upload:
  - validate schema and ranges,
  - apply to NVS,
  - reboot required to take effect.
- Recommended: export excludes secrets by default (Wi-Fi PSK, STT token, admin hash) unless user explicitly opts in.

---

## 5. STT Endpoint Contract

### 5.1 Request
- Method: `POST`
- Auth: per configured auth scheme
- Body: raw audio, recommended WAV (PCM) for simplicity

### 5.2 Response
- JSON with at least:
  - `text` (string)

Example:

```json
{ "text": "hello world" }
```

Device behavior:
- If `text` is empty/whitespace-only, do not type.
- Optional: trim whitespace; optional newline per config.

---

## 6. Data Structures and Sizing

At 16kHz, 16-bit mono:
- 1 second audio = 16,000 samples × 2 bytes = 32,000 bytes

Suggested defaults:
- `pre_roll_ms = 300` → ~9,600 bytes
- `max_utt_ms = 15000` → ~480,000 bytes

PSRAM is strongly recommended to simplify buffering and TLS memory usage.

---

## 7. Parts List (BOM)

### 7.1 Core Board (choose one)
Any ESP32-S3 board with native USB device support and preferably PSRAM:
- Adafruit ESP32-S3 QT Py (Product 5700)
- Unexpected Maker TinyS3[D] (Product 6401)
- Adafruit ESP32-S3 Feather (Product 5477; select PSRAM variant)
- Adafruit ESP32-S3 TFT Feather (Product 5483; TFT not required)

### 7.2 Microphone
- I2S MEMS microphone breakout/module (3.3V), pins:
  - VCC, GND, BCLK/SCK, LRCLK/WS, DOUT/SD

### 7.3 Button
- 1× momentary tactile switch

### 7.4 LED
Use onboard RGB LED if present, otherwise:
- Option A: 1× WS2812/NeoPixel RGB LED + optional 330Ω series resistor on data line
- Option B: 1× red LED + 1× green LED + 2× resistors (2 GPIOs)

### 7.5 Wiring / Mechanical
- 28–30 AWG hookup wire
- heatshrink tubing
- small perfboard (optional)
- small enclosure (with mic opening) + USB strain relief

---

## 8. Example Pin Mapping (Adjust as Needed)

### 8.1 I2S Mic (example GPIOs)
- MIC DOUT → GPIO 4
- MIC BCLK → GPIO 5
- MIC LRCLK → GPIO 6
- MIC VCC → 3V3
- MIC GND → GND

### 8.2 Button
- Button → GPIO 9 and GND
- Configure GPIO 9 as `INPUT_PULLUP`

### 8.3 LED
- Onboard NeoPixel: board-defined pin
- External WS2812:
  - DIN → GPIO 10
  - VDD → 3V3 (or 5V per LED spec)
  - GND → GND

---

## 9. Brief Assembly Guide

### 9.1 Hardware Assembly
1. Mount ESP32-S3 board in enclosure (or prep for compact wiring).
2. Wire I2S microphone to selected GPIOs + 3V3/GND.
3. Wire button: GPIO to GND (use internal pull-up).
4. LED:
   - onboard RGB LED: no wiring, OR
   - external LED: wire per section 8.3.
5. Ensure mic has an opening to ambient air.

### 9.2 Firmware Bring-Up Checklist
1. Flash firmware over USB.
2. First boot (unconfigured) should start AP mode:
   - connect to `VoiceDongle-XXXX`
   - open `http://192.168.4.1/`
3. Login with default credentials → set admin password.
4. Configure:
   - STA Wi-Fi SSID/PSK
   - STT endpoint + auth
   - keyboard settings
   - audio gate params
5. Apply & reboot; device joins Wi-Fi.
6. Verify LAN UI access at `http://<device-ip>/`.
7. Verify controls:
   - short press toggles red/green
   - hold 5s enters AP mode
   - hold 15s factory resets to AP mode
8. Verify dictation:
   - focus a text field on host,
   - enable (green),
   - speak; device types STT output.

---

## 10. Default Settings (Suggested)
- Audio:
  - sample_rate_hz: 16000
  - pre_roll_ms: 300
  - silence_hang_ms: 600
  - max_utt_ms: 15000
  - start_threshold: fixed value or derived from brief ambient measurement
  - stop_threshold_ratio: 0.7
- Keyboard:
  - layout: us
  - key_delay_ms: 10
  - append_newline: false
- Button holds:
  - AP mode: 5 seconds
  - Factory reset: 15 seconds

---

## 11. Acceptance Criteria
- Fresh device boots into AP mode and can be fully configured via portal.
- Device joins Wi-Fi in STA mode after configuration and can reach STT endpoint.
- Hold 5 seconds enters AP mode without wiping config.
- Hold 15 seconds wipes config and reboots into AP mode.
- LED red: no audio capture and no STT traffic.
- LED green: silence-gated utterance capture with pre-roll; typed STT output appears as keyboard input.
